#anki-word-assistanthrome浏览器插件开发项目文档
**项目名称：** Anki单词助手插件  
**文档版本：** v1.0  
**创建日期：** 2025年1月  

## 1. 项目背景与原始需求

### 1.1 项目目标
开发一款Chrome浏览器插件，用于将单词查询结果自动化处理并导入到Anki记忆卡片系统中，提升语言学习效率。

### 1.2 原始需求描述

**核心功能需求：**

**(1) AI解析功能**
- 用户将单词查询结果文本复制到插件popup页面的输入框中
- 点击解析按钮后，调用AI进行结构化分析
- 重新输出为结构化数据，格式为：
  - 正面：单词
  - 背面：完整的单词查询结果（保留换行）

**(2) Anki集成功能**
- 点击写入按钮，调用本地的anki软件中的AnkiConnect插件
- AnkiConnect应该已经监听在本地的某个端口
- 在anki桌面版中创建一个单词卡片

**(3) 配置管理功能**
- 暂时只使用gemini进行ai解析（后续需要预留支持指定AI种类openai，gemini等；指定模型名称和key）
- 支持测试ai模型连通性
- 要预留多语言配置（暂时只需要支持中文）

### 1.3 示例数据
**输入示例（单词查询结果文本）：**
```
https://youglish.com/pronounce/%E3%82%AC%E3%83%81%E3%83%A3%E5%88%87%E3%82%8A/japanese
单词释义
假名发音：ガチャぎり 
中文释义：突然挂断电话；粗暴挂断电话 
详细解释：指在通话过程中，不打招呼、不道别，突然、粗暴地挂断电话的行为。通常带有不礼貌、不负责任的负面含义。
场景例句
彼は話の途中で、いきなりガチャ切りした。 (他话说到一半，突然就挂断了电话。)
お客様からの電話をガチャ切りするのは、絶対にやめてください。 (请绝对不要粗暴地挂断客户的电话。)
扩展
词源：由电话挂断时发出的"ガチャ"声和"切る"（挂断）组合而成。 
衍生用法：无 
相似用法：無言電話（むごんでんわ - 骚扰电话，通常指不说话的电话）、いたずら電話（いたずらでんわ - 恶作剧电话）
```

**期望输出格式：**
- 卡片正面：ガチャ切り
- 卡片背面：保留上述完整内容（包含换行格式）

### 1.4 参考资源
- AnkiConnect项目：https://git.sr.ht/~foosoft/anki-connect

## 2. 需求澄清与决策记录

### 2.1 技术选型决策

| 决策点 | 选择结果 | 理由 |
|--------|----------|------|
| Chrome插件版本 | Manifest V3 | 最新标准，V2将被淘汰 |
| API调用方式 | REST API | 简单直接，满足需求 |
| AI解析失败处理 | 弹出错误提示即可 | 简化实现，用户可重试 |
| 离线功能支持 | 不支持 | 依赖在线AI服务，无需离线 |
| 结果编辑支持 | 允许手动编辑解析结果 | 提升用户体验和准确性 |

### 2.2 简化需求决策

**基于开发效率考虑，以下需求进行简化：**

| 原始需求 | 简化决策 | 说明 |
|----------|----------|------|
| 支持多种卡片模型 | 暂时只使用Basic模型 | Basic模型包含Front/Back两个字段，满足基本需求 |
| 支持多个牌组 | 暂时使用Default牌组 | 降低配置复杂度 |
| 失败重试机制 | 不处理，弹出提示即可 | 用户可手动重试 |
| 缓存策略 | 不加入缓存策略 | 简化架构 |
| 自动标签添加 | 不进行自动添加标签 | 减少复杂逻辑 |
| 自定义Prompt | Prompt放在自定义部分 | 用户可根据需要调整AI解析逻辑 |

### 2.3 扩展性预留

**虽然当前简化实现，但架构需预留以下扩展能力：**
- 多AI服务支持（OpenAI、Claude等）
- 多语言界面支持
- 自定义Prompt模板
- 多卡片模型支持
- 多牌组选择

## 3. 技术调研结果

### 3.1 AnkiConnect API调研

**基础信息：**
- 默认端口：8765
- API版本：v6
- 请求方式：HTTP POST
- 数据格式：JSON

**核心API接口：**

**(1) 连接测试**
```json
{
  "action": "version",
  "version": 6
}
```

**(2) 创建卡片**
```json
{
  "action": "addNote",
  "version": 6,
  "params": {
    "note": {
      "deckName": "Default",
      "modelName": "Basic",
      "fields": {
        "Front": "单词内容",
        "Back": "完整查询结果"
      },
      "tags": [],
      "options": {
        "allowDuplicate": false
      }
    }
  }
}
```

**重要发现：**
- `tags`字段是必填的，即使为空数组
- 如果Anki浏览器窗口打开，某些更新操作可能不生效
- `modelName`必须使用Anki中实际存在的模型名称

### 3.2 Google Gemini API调研

**基础信息：**
- API端点：`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent`
- 认证方式：API Key
- 请求方式：HTTP POST

**JSON格式输出配置：**
```json
{
  "contents": [
    {
      "parts": [
        {
          "text": "用户prompt + 原始文本"
        }
      ]
    }
  ],
  "generationConfig": {
    "response_mime_type": "application/json"
  }
}
```

**重要特性：**
- 支持结构化JSON输出（仅限Gemini 1.5系列）
- 可通过`generationConfig`控制输出格式
- 支持自定义JSON schema

## 4. 系统架构设计

### 4.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Chrome插件    │    │   Gemini API    │    │  AnkiConnect    │
│    (前端UI)     │◄──►│   (AI解析)      │    │   (Anki集成)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                                              │
         └──────────────────────────────────────────────┘
```

### 4.2 数据流设计
```
用户输入文本 → AI解析请求 → 结构化数据 → 用户确认编辑 → Anki写入 → 结果反馈
```

### 4.3 核心数据结构

**配置数据结构：**
```javascript
{
  "aiConfig": {
    "provider": "gemini",
    "models": {
      "gemini": {
        "apiKey": "encrypted_key",
        "modelName": "gemini-1.5-flash",
        "endpoint": "https://generativelanguage.googleapis.com/..."
      }
    }
  },
  "ankiConfig": {
    "defaultDeck": "Default",
    "defaultModel": "Basic",
    "defaultTags": []
  },
  "promptTemplates": {
    "default": "请将以下单词查询结果解析为结构化数据...",
    "custom": ""
  },
  "language": "zh-CN"
}
```

**解析结果数据结构：**
```javascript
{
  "front": "单词",
  "back": "完整的单词查询结果（保留换行格式）"
}
```

## 5. 项目结构

```
anki-word-assistant/
├── manifest.json                 # Chrome插件配置文件
├── popup/
│   ├── popup.html               # 主界面HTML
│   ├── popup.js                 # 主界面逻辑
│   └── popup.css                # 主界面样式
├── options/
│   ├── options.html             # 配置页面HTML
│   ├── options.js               # 配置页面逻辑
│   └── options.css              # 配置页面样式
├── utils/
│   ├── ankiconnect.js           # AnkiConnect API封装
│   ├── ai-service.js            # AI服务统一接口
│   ├── storage.js               # 配置存储管理
│   └── i18n.js                  # 国际化工具
├── locales/
│   └── zh-CN.json               # 中文语言包
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
└── README.md
```

## 6. 详细功能规格

### 6.1 Manifest V3配置要求

**必需权限：**
```json
{
  "permissions": ["storage"],
  "host_permissions": [
    "http://127.0.0.1:8765/*",
    "https://*.googleapis.com/*"
  ]
}
```

### 6.2 主界面功能（popup.html）

**界面布局：**
- 顶部：标题栏和状态指示器
- 中上：文本输入区域（textarea，支持多行输入）
- 中部：操作按钮区域（"解析"、"写入Anki"按钮）
- 中下：结果预览区域（显示解析后的结构化数据，支持编辑）
- 底部：状态消息显示区域

**核心交互流程：**
1. 用户粘贴单词查询结果到输入框
2. 点击"解析"按钮，调用AI进行结构化分析
3. 显示解析结果，用户可编辑正面和背面内容
4. 点击"写入Anki"按钮，创建记忆卡片
5. 显示操作成功或失败的反馈信息

**状态管理：**
- 空闲状态：等待用户输入
- 解析中：显示loading动画，按钮禁用
- 解析完成：显示结果，允许编辑
- 写入中：显示writing动画
- 完成：显示成功信息
- 错误：显示具体错误信息

### 6.3 配置页面功能（options.html）

**AI服务配置区域：**
- AI服务商选择：下拉框（当前仅Gemini，预留OpenAI等）
- API Key输入：密码类型输入框，加密存储
- 模型名称：文本输入框（默认：gemini-1.5-flash）
- "测试AI连接"按钮：验证API配置是否有效

**Prompt配置区域：**
- 默认模板显示：只读文本区域，展示内置prompt
- 自定义模板编辑：可编辑文本区域
- "恢复默认"按钮：重置为内置prompt

**AnkiConnect配置区域：**
- "测试Anki连接"按钮：检测AnkiConnect是否可用
- 连接状态显示：实时显示连接状态

**系统设置区域：**
- 语言选择：下拉框（当前仅中文）
- "保存配置"按钮：持久化所有设置

### 6.4 核心模块功能规格

**ankiconnect.js模块：**
```javascript
// 主要方法
async function testConnection()        // 测试连接
async function addNote(noteData)       // 创建卡片  
async function getDeckNames()          // 获取牌组列表（预留）
async function getModelNames()         // 获取模型列表（预留）
```

**ai-service.js模块：**
```javascript
// 主要方法
async function parseText(inputText, prompt)  // AI文本解析
async function testConnection(apiKey)        // 测试AI服务连接
function buildPrompt(inputText, template)    // 构建完整prompt
```

**storage.js模块：**
```javascript
// 主要方法
async function saveConfig(config)      // 保存配置
async function loadConfig()           // 加载配置  
async function encryptApiKey(key)     // 加密API Key
async function decryptApiKey(key)     // 解密API Key
```

## 7. 开发顺序和里程碑

### 阶段1：基础架构搭建（3-5天）
**目标：** 完成插件基础框架和配置系统

**主要任务：**
- 创建manifest.json和目录结构
- 实现配置存储模块（storage.js）
- 搭建基础UI界面（HTML/CSS）
- 实现多语言框架基础
- 配置开发调试环境

**验收标准：**
- 插件能正常加载到Chrome浏览器
- 配置页面能保存和读取基本设置
- 主界面能正常显示和响应用户操作

### 阶段2：AnkiConnect集成（2-3天）  
**目标：** 完成与Anki的通信和卡片创建功能

**主要任务：**
- 实现ankiconnect.js API封装模块
- 实现连接测试功能
- 实现addNote卡片创建功能  
- 实现错误处理和用户反馈
- 在配置页面添加Anki连接测试

**验收标准：**
- 能检测Anki及AnkiConnect运行状态
- 能成功创建Basic类型测试卡片到Default牌组
- 各种错误场景都有友好的提示信息

### 阶段3：AI服务集成（3-4天）
**目标：** 完成Gemini API集成和文本解析功能  

**主要任务：**
- 实现ai-service.js统一接口模块
- 实现Gemini API调用逻辑
- 设计和实现默认prompt模板
- 实现JSON响应解析和数据验证
- 实现AI连通性测试功能
- 在配置页面添加AI相关设置界面

**验收标准：**
- 能成功调用Gemini API并获取结构化输出
- 能正确解析单词查询结果为front/back格式
- prompt模板支持用户自定义
- API调用错误能正确捕获和提示

### 阶段4：主界面功能实现（3-4天）
**目标：** 实现完整的用户操作流程

**主要任务：**
- 实现popup.js核心业务逻辑
- 完善用户界面和交互体验
- 实现解析结果的展示和编辑功能
- 整合AI解析和Anki写入的完整流程  
- 实现完整的状态管理和反馈机制
- 界面样式优化和响应式适配

**验收标准：**
- 从文本输入到卡片创建的完整流程可用
- 界面友好，操作状态反馈及时准确
- 支持对解析结果的预览和手动编辑
- 各个操作步骤都有清晰的状态提示

### 阶段5：完善优化（2-3天）
**目标：** 完善细节，提升用户体验

**主要任务：**
- 完善各种边界情况和错误场景处理
- 优化界面布局，提升用户体验
- 完成完整的中文本地化
- 添加操作说明和帮助信息
- 全面功能测试和bug修复
- 性能优化和代码清理

**验收标准：**
- 各种异常情况都有合适的错误处理
- 界面在不同屏幕尺寸下都能正常显示
- 所有文本都有中文本地化
- 功能稳定，无明显缺陷

### 阶段6：发布准备（1-2天）
**目标：** 准备项目交付

**主要任务：**
- 编写完整的README文档和使用说明
- 准备插件图标和宣传截图
- 整理代码结构，添加注释文档
- 最终集成测试
- 准备Chrome Web Store发布材料

## 8. 关键技术风险与应对

### 8.1 主要技术风险

**AnkiConnect依赖风险：**
- 风险：用户未安装AnkiConnect或配置错误
- 应对策略：提供详细安装指南，实现连接状态检测

**AI API限制风险：**
- 风险：API调用频率限制或网络连接问题
- 应对策略：提供清晰的错误提示和重试建议

**跨域请求限制：**
- 风险：浏览器安全策略阻止API调用
- 应对策略：正确配置manifest权限声明

### 8.2 用户体验风险

**配置复杂度风险：**
- 风险：用户配置AI服务门槛过高
- 应对策略：提供详细配置指导，考虑提供默认配置

**AI解析准确性风险：**
- 风险：AI解析结果不准确或格式错误
- 应对策略：支持结果手动编辑，允许自定义prompt调优

## 9. 测试验证要求

### 9.1 功能测试覆盖
- **AnkiConnect集成测试：** 连接检测、卡片创建、错误处理
- **AI服务测试：** API调用、JSON解析、错误场景覆盖  
- **配置管理测试：** 存储读写、加密解密、数据验证
- **用户界面测试：** 交互响应、状态管理、数据绑定

### 9.2 兼容性测试  
- **浏览器兼容性：** Chrome不同版本测试
- **系统兼容性：** Windows/macOS/Linux环境测试
- **Anki版本兼容性：** 不同Anki版本的AnkiConnect测试

### 9.3 性能和稳定性测试
- **大文本处理：** 长文本输入的处理性能
- **API响应时间：** 网络延迟对用户体验的影响
- **内存使用：** 长时间使用的内存泄漏检测

## 10. 项目交付物

### 10.1 代码交付物
- 完整的Chrome插件源代码
- 详细的代码注释和文档
- 构建和部署脚本（如需要）

### 10.2 文档交付物  
- 项目开发文档（本文档）
- 用户使用说明书
- API接口文档
- 测试报告和已知问题列表

### 10.3 资源文件
- 插件图标和界面素材
- 多语言文本资源
- Chrome Web Store发布材料

---

**开发周期预估：** 15-20个工作日  
**推荐开发环境：** Chrome浏览器 + VS Code + Git  
**前置依赖：** Anki桌面版 + AnkiConnect插件 + Gemini API Key

此文档为完整的项目需求和开发指导文档，包含了从原始需求到技术实现的所有关键信息，可作为开发团队的完整参考资料。