# 跨平台移植评估与方案（Windows/macOS）

本文结合当前项目形态（Chrome MV3 扩展，已接入 AnkiConnect 与多家 AI 提供商），并考虑后续计划完成的“动态字段解析”和“多语言支持”，对跨平台移植路线进行系统评估并给出推荐方案与实施路线图。

## 1. 背景与目标

- 当前形态：
  - 类型：Chrome 浏览器扩展（Manifest V3）
  - 主要模块：`popup/`、`options/`、`utils/ai-service.js`、`utils/ankiconnect.js`、`utils/storage.js`、`_locales/`
  - 依赖：
    - 本地 `AnkiConnect`（`http://127.0.0.1:8765`）
    - 外部 AI 接口（Google, OpenAI, Anthropic）
    - 浏览器存储（`chrome.storage.local`）与 `fetch`
  - 约束：后续将完成“动态字段解析（纯函数更佳）”与“多语言支持（_locales 结构）”。

- 目标：
  - 在 Windows 与 macOS 上提供一致、可安装、可更新的用户体验；
  - 保障浏览器场景下的“选中/复制-生成-加卡”主流程稳定；
  - 最小化重写，最大化复用已有前端与业务逻辑。

## 2. 备选方案评估

### 方案 A：保持浏览器扩展形态并扩展到 Safari（推荐）

- 思路：
  - 维持 MV3 架构，适配 Chrome/Edge/Firefox；基于 Xcode 将 WebExtension 转为 Safari Web Extension（macOS）。
  - 沿用现有 `popup` / `options` / `utils` 与 `_locales` 结构，最小改动完成跨平台。

- 优势：
  - 与“网页即取即用”的核心场景最契合（选词、页面上下文）；
  - 改造量小，复用率高；
  - 分发与更新路径清晰：Chrome Web Store / Edge Add-ons / AMO / Mac App Store（Safari 扩展承载于宿主 App）。

- 劣势与风险：
  - Safari 审核、签名与宿主 App 打包链路相对繁琐；
  - MV3 在各浏览器实现细节不同（Service Worker 生命周期、权限策略）；
  - 需要确保对 `http://127.0.0.1:8765`（AnkiConnect）的访问权限与 CORS/ATS 配置正确。

- 核心技术点：
  - Manifest 兼容性：补齐 `host_permissions`（建议加入 `https://api.openai.com/*`、`https://api.anthropic.com/*` 等）。
  - API 差异：`chrome.*` 与 `browser.*` 的细节差异；可引入简单的适配层。
  - Safari Web Extension：使用 Xcode 的转换向导或 `xcrun safari-web-extension-converter`；为宿主 App 配置网络出站能力与 ATS 例外（若需）。
  - 多语言：直接复用 `_locales`；确保 Safari 侧映射正确。

### 方案 B：桌面应用（Tauri）

- 思路：
  - UI 复用现有 HTML/CSS/JS，采用系统 WebView（Win: WebView2；macOS: WebKit）；
  - Rust 侧提供托盘、全局快捷键、剪贴板、配置持久化等能力；
  - 与 AnkiConnect/AI 仍通过 HTTP `fetch` 通讯。

- 优势：
  - 包体小、性能好、安全基线较高；
  - 一套工程同时产出 Windows 与 macOS 安装包；
  - 易于加入系统级能力（剪贴板、热键、托盘、开机自启）。

- 劣势与风险：
  - 需要引入 Rust 构建链；
  - 无法像扩展那样与任意网页直接交互（content script 注入能力有限），需改交互为“复制/剪贴板 → 热键触发 → 生成与加卡”；
  - 需要替换 `chrome.storage` 为本地存储（Tauri storage/文件）。

- 核心技术点：
  - 页面迁移：将 `options.html` 作为主窗口，`popup.html` 作为工具窗；
  - 配置抽象：封装 `loadConfig/saveConfig` 接口，扩展端走 `chrome.storage`，桌面端走 Tauri 存储；
  - 网络：直连 AI 与 AnkiConnect；处理代理/证书/限流与错误恢复。

### 方案 C：桌面应用（Electron）

- 优势：Web 能力最强、生态成熟、迁移前端几乎零成本；
- 劣势：包体显著更大、资源占用高；签名与自动更新相对繁琐；
- 结论：在此项目体量与诉求下，不作为首选。

### 方案 D：Anki 插件（Add-on）

- 优势：与 Anki 深度耦合，无需 AnkiConnect；
- 劣势：需以 Python/Qt 重写 UI 与逻辑，且脱离“网页即取即用”场景；
- 结论：不符合当前产品定位，不推荐作为主线。

## 3. 场景对齐与方案选择

- 核心场景是“在网页上下文中快速取词并加卡”，扩展形态最合适；
- 若未来需要“系统级热键/剪贴板工作流”，可增设桌面端作为补充。

结论：
- 主路径：方案 A（扩展到 Safari Web Extension），以最小代价覆盖 Windows 与 macOS。
- 备选路径：方案 B（Tauri 桌面端），在需要浏览器外部使用或系统级能力时推进。

## 4. 实施路线图

### Phase 1：跨浏览器兼容基线（1 周）

- Manifest 梳理：
  - 校验并补齐 `host_permissions`：`http://127.0.0.1:8765/*`、`https://*.googleapis.com/*`、`https://api.openai.com/*`、`https://api.anthropic.com/*`；
  - 确认 `permissions` 仅保留必要项（当前仅 `storage`）。
- API 适配：引入轻量 `chrome/browser` 适配层，避免条件分支散落各处。
- Service Worker：确保 MV3 背景脚本唤起与生命周期稳定（必要时延迟任务/消息唤醒）。
- 本地开发验证：Chrome、Edge、Firefox 本地加载验证；AnkiConnect 通路验证。

### Phase 2：Safari Web Extension 适配与打包（1–2 周）

- 转换：使用 Xcode 转换 WebExtension（或 `xcrun safari-web-extension-converter`）。
- 宿主 App：
  - 配置网络出站能力与必要的 ATS 例外（若直连 `http://127.0.0.1:8765` 需评估 ATS 行为）；
  - 申请并配置签名证书与 Team；
  - 版本号、图标、描述与 `_locales` 文案映射。
- 权限与策略：核对 Safari 对 MV3 的实现差异（如 Service Worker、CSP）。
- 验证：
  - 在 macOS 上安装 Anki+AnkiConnect，完成从取词到加卡的闭环；
  - 多语言：确认 `_locales` 与 `i18n.js` 行为一致；
  - 网络：AI 三家均可通。

### Phase 3：分发与合规（并行进行）

- 商店准备：
  - Chrome Web Store / Edge Add-ons / Firefox AMO 上架物料；
  - Safari 通过 Mac App Store（宿主 App 承载扩展）。
- 文档与支持：
  - 安装与配置指南（Anki、AnkiConnect、API Key）；
  - 隐私政策与数据出站域名清单；
  - 常见错误排查（Anki 未运行/端口占用/API Key 失效等）。

### Phase 4（可选）：Tauri 桌面 PoC（3–4 周）

- UI：`options.html` 作为主窗，`popup.html` 作为工具窗；
- 系统能力：全局快捷键、剪贴板监控、托盘入口；
- 存储：替换 `chrome.storage`，实现统一的配置访问接口；
- 验证：复制→热键→生成→加卡的链路闭环；
- 打包：Win 安装包（MSI/EXE），macOS（DMG/ZIP/签名）。

## 5. 成本与风险评估

- 粗略工期：
  - 方案 A：1–2 周完成跨浏览器与 Safari 首包；商店审核另计（1–3 周不定）。
  - 方案 B：PoC 3–4 周，完善与分发 5–6 周（含签名与自动更新）。

- 风险与缓解：
  - 浏览器差异（MV3 行为）：以最小 API 集合与适配层缓解；
  - AnkiConnect 本地访问：权限/ATS 配置与回退提示（检测端口/服务状态并给出引导）；
  - AI 接口限流/错误：重试与退避、健康状态上报（现有 `updateProviderHealth` 可复用）、候选顺序回退（已实现）；
  - 合规：隐私政策、域名白名单、错误日志默认本地化（不上云）。

## 6. 与现有代码的改造要点

- 最大复用：
  - `utils/ai-service.js`、`utils/ankiconnect.js`、`utils/i18n.js`、`utils/storage.js`、`options/`、`popup/`；
  - “动态字段解析”建议封装为纯函数模块，避免依赖浏览器特有 API，便于桌面与扩展共享。

- 适配建议：
  - 存储接口抽象：定义 `loadConfig/saveConfig` 统一接口，扩展端保持 `chrome.storage`，桌面端落地于本地存储；
  - 网络配置：将 AI 与 AnkiConnect 端点抽象到配置中（已部分存在），便于测试/替换；
  - i18n：保持 `_locales` 与消息 key 的稳定性；
  - 权限清单：补齐 `host_permissions`（OpenAI/Anthropic）。

## 7. 成功标准（Definition of Done）

- Windows/macOS：
  - 安装后可完成“配置 API Key → AI 生成 → 加卡到 Anki”的闭环；
  - Safari（macOS）上行为与 Chrome 基本一致；
  - 多语言自动生效，UI 文案与格式正确；
  - 错误提示具备可诊断性（服务未运行/网络失败/权限不足）。

## 8. 测试要点

- 行为级测试：
  - 不同浏览器（Chrome/Edge/Firefox/Safari）基础流程；
  - Anki 未运行 / 端口占用 / API Key 失效 / 限流 / 网络中断的降级与提示；
  - 多语言切换与 `_locales` 加载；
  - Service Worker 唤起与持久任务。

- 桌面 PoC（可选）：
  - 剪贴板→热键→生成→加卡；
  - 托盘菜单操作；
  - 配置持久化与迁移；
  - 网络代理环境兼容性。

## 9. 里程碑与交付物

- M1：跨浏览器与权限清单就绪（清单与适配层、验证记录）。
- M2：Safari Web Extension 首包（转换产物、签名配置、ATS 明细、测试报告）。
- M3：商店材料与上架（描述、截图、隐私与支持文档）。
- M4（可选）：Tauri 桌面 PoC（二进制、说明书、差异清单）。

---

结论：优先选择“扩展到 Safari”的路线，以最小成本覆盖 Windows 与 macOS 的主使用场景；当产品需求扩展到系统级能力时，再增量推进 Tauri 桌面端，复用现有业务逻辑并通过接口抽象降低迁移成本。

