基于“C:\Dev\anki-word-assistant\docs\ai-provider-refactor-outline.md”和“C:\Dev\anki-word-assistant\docs\ai-provider-refactor-plan.md”的代码审查问题报告。

---

🔍 潜在问题和改进建议

● ⚠️ 发现的问题

1. 缺少测试脚手架 (Stage 0)

- 问题: 计划中的 Stage 0(测试骨架)未实施
- 位置: package.json 无 test 脚本,tests/ 目录不存在
- 影响: 无法验证重构的正确性,缺乏回归测试保障
- 建议:
  - 添加 npm test 脚本
  - 使用 node --test 或其他测试框架
  - 为核心功能编写单元测试

2. 配置文件缺少导出类型定义

- 问题: providers.config.js 未导出常量供外部校验
- 位置: providers.config.js
- 影响: 无法在其他模块中访问 PROVIDERS, DEFAULT_RETRY_POLICY 等
- 建议: 导出常量用于类型检查和文档生成

3. 错误处理不一致

- 问题: 某些函数吞掉错误或使用空 catch 块
- 位置:
  - ai-service.js:189 - errorParser 错误被忽略
  - storage.js:618-623 - 解密失败仅 console.warn
- 影响: 调试困难,错误信息丢失
- 建议: 统一错误处理策略,记录完整错误栈

4. 配置版本硬编码

- 问题: CONFIG_VERSION = "2.2" 硬编码在多处
- 位置: storage.js:12, options.js:1274
- 影响: 版本更新时需要多处修改
- 建议: 从单一来源导出版本号

5. API Key 泄露风险

- 问题: 导出配置时虽然清空了 API Key,但日志中可能泄露
- 位置: options.js:1276-1287
- 影响: 日志或错误信息可能暴露敏感数据
- 建议:
  - 所有日志中屏蔽 API Key
  - 使用正则替换敏感字段为 \*\*\*

6. 缺少 IMPLEMENTATION_PLAN.md

- 问题: 计划中要求维护 IMPLEMENTATION_PLAN.md,但未找到
- 位置: 项目根目录
- 影响: 无法追踪各阶段完成状态
- 建议: 创建该文件并更新状态

7. 健康检查文案不一致

- 问题: 健康检查 Prompt 在中文和日文之间混用
- 位置:
  - ai-service.js:20 - 中文
  - providers.config.js:30 - 日文
- 影响: 用户体验不一致
- 建议: 统一为中文或支持多语言

8. 缺少 OpenAI 兼容供应商示例

- 问题: 计划中提到添加新的 OpenAI 兼容供应商(如 DeepSeek)作为验证,但未实现
- 位置: providers.config.js
- 影响: 无法验证可扩展性
- 建议: 添加一个 OpenAI 兼容供应商示例(如 DeepSeek 或 Groq)

9. options.html 仍有静态 DOM

- 问题: HTML 中仍有供应商配置容器的静态结构
- 位置: options.html:324-329
- 影响: 虽然被 JavaScript 覆盖,但违背了"完全动态渲染"的目标
- 建议: 清理 HTML,仅保留容器

10. 文档未更新

- 问题: README.md, PRIVACY_POLICY.md 未同步更新
- 位置: 项目根目录
- 影响: 用户和开发者文档过时
- 建议: 更新文档,说明新的配置方式

---

✅ 总体评价

重构完成度: 85%

已完成的核心目标:

- ✅ 供应商配置集中化
- ✅ 动态数据驱动 UI
- ✅ OpenAI 兼容层实现
- ✅ 存储迁移机制
- ✅ 权限动态管理
- ✅ 健康状态追踪

缺失的计划内容:

- ❌ Stage 0: 测试脚手架和自动化测试
- ❌ 文档更新(用户指南/开发指南)
- ❌ OpenAI 兼容供应商验证示例
- ❌ IMPLEMENTATION_PLAN.md 维护

代码质量:

- ✅ 架构清晰,职责分离良好
- ✅ 配置结构合理,扩展性强
- ✅ 错误处理基本完善
- ⚠️ 缺少类型检查(JSDoc/TypeScript)
- ⚠️ 缺少单元测试覆盖
