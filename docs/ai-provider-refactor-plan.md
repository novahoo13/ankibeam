# AI供应商集成重构计划

## 背景
- 现有实现将 Google、OpenAI、Anthropic 相关数据散落在 `utils/ai-service.js`、`utils/storage.js`、`options/options.js` 与 `options/options.html` 中，扩展新供应商需要多处改动。
- 项目目标是用“OpenAI 兼容 API + 少量特殊处理”覆盖主流供应商，同时保持扩展体积小、维护成本低。

## 总体目标
- 引入配置驱动的供应商元数据，统一管理模型、端点、鉴权与健康检查策略。
- 提取 OpenAI 兼容调用路径，减少重复实现在 API 调用、重试与校验逻辑中的分支。
- 让选项页面的供应商表单与 `chrome.storage` 中的结构自动匹配，降低添加新供应商时的 UI 与存储改动量。
- 完成旧配置向新结构的迁移，并确保三大内置供应商在迁移后功能等价。

## 范围与排除项
- **包含**：配置文件设计、AI 服务调用重构、存储结构调整、选项页动态渲染、host 权限策略、迁移脚本与测试。
- **排除**：新引入 SDK、Manifest V2/V3 之间的迁移、非 AI 功能（如 Anki 交互、样式编辑器）的大幅改造。

## 风险与缓解
- **配置迁移失败**：在迁移脚本中保留回退路径，当解析或解密失败时落回默认配置并提示用户重配。
- **OpenAI 兼容差异**：在元数据中支持自定义 header / path / payload 适配器，并为非常规供应商保留专用处理。
- **host 权限爆炸**：维护基础白名单，并评估是否引入 `chrome.permissions.request` 动态获取额外域名。
- **UI 重构复杂度**：分阶段迁移，先实现元数据驱动的渲染骨架，再迁移现有三个供应商的配置确认行为正确。

## 里程碑
- 完成元数据与调用抽象后，项目应可通过新增配置条目支持新的 OpenAI 兼容服务，无需修改核心逻辑。
- 选项页新增供应商时，只需配置表单字段映射与文案，无需手工复制 DOM。

## Stage 1: 供应商元数据抽离
**Goal**: 在 `utils` 下新增集中配置（如 `providers.config.js`），描述供应商类型、默认模型、API 模板、健康检查参数。  
**Success Criteria**: 三个现有供应商的信息完全迁移到新配置文件，`ai-service` 与 UI 可通过读取配置获得相同信息。  
**Tests**: 单元测试或最小集成测试验证配置载入和基本字段存在性；手动检查配置可被 `options/options.js` 正确读取。  
**Status**: Not Started

## Stage 2: 存储结构与加密升级
**Goal**: 让 `chrome.storage` 中的 `aiConfig` 与加密逻辑适配动态供应商列表，可根据元数据自动初始化 / 加解密。  
**Success Criteria**: 新增供应商无需修改 `DEFAULT_CONFIG` 与 `PROVIDER_SALTS` 即可保存/读取 API Key；旧数据自动迁移且不丢失。  
**Tests**: 针对 `saveConfig` 和 `loadConfig` 的单元测试覆盖旧配置迁移、新供应商加解密、缺失盐值回退；手动测试保存/读取。  
**Status**: Not Started

## Stage 3: AI 服务调用抽象
**Goal**: 在 `ai-service` 中实现 `callOpenAICompatible` 等通用函数，通过配置生成请求路径、headers 与 payload；特殊供应商保持独立实现。  
**Success Criteria**: `callProviderAPI` 使用配置驱动的分派逻辑；OpenAI 兼容供应商共享同一实现；重试与健康检查逻辑无回归。  
**Tests**: 针对通用调用构造 mock fetch 测试；对 Google / Anthropic 特殊路径编写针对性测试；运行现有集成测试。  
**Status**: Not Started

## Stage 4: 选项页与交互层重构
**Goal**: 使用供应商元数据动态渲染选项页中的表单、测试按钮与文案，确保 UI 与存储结构保持一致。  
**Success Criteria**: 删除硬编码的供应商 DOM 块；新增供应商只需配置即可在 UI 中呈现；测试按钮依旧可调用 `testConnection`。  
**Tests**: 编写 DOM 级别的单元测试或使用 jsdom 验证渲染逻辑；手动在浏览器扩展环境中验证三家供应商配置、测试、保存流程。  
**Status**: Not Started

## Stage 5: Manifest 权限与迁移验证
**Goal**: 根据供应商配置生成或验证需要的 `host_permissions`，并完成旧版本配置到新结构的迁移及通知。  
**Success Criteria**: Manifest 中存在满足默认供应商的域名；提供扩展策略（静态列表或动态申请）以支持自定义域；迁移脚本对旧配置成功执行。  
**Tests**: 手动检查安装包权限；测试迁移脚本针对旧存储快照；在 Chrome 扩展开发模式下验证权限是否阻塞调用。  
**Status**: Not Started

## 任务清单
- **配置抽象**
  - 定义供应商元数据结构（类型、端点、鉴权、模型、UI 字段映射）。
  - 将现有供应商信息迁移到新配置文件并提供类型校验（若使用 TS / JSDoc）。
- **存储与迁移**
  - 重写默认配置生成逻辑以利用元数据。
  - 调整加密盐生成策略，允许为新供应商自动生成或人性化声明。
  - 编写迁移函数处理旧格式（含缺失 `apiUrl` 字段）的数据。
- **AI 调用层**
  - 实现 `callOpenAICompatible` 通用函数，支持可配置的路径与 header。
  - 为特殊供应商（Google、Anthropic）保留独立实现并接入统一分发。
  - 更新健康检查、回退顺序逻辑以适配动态供应商集合。
- **选项页重构**
  - 引入基于配置的表单渲染（模板或虚拟节点），移除硬编码 DOM。
  - 统一 API Key 展示与加密/明文切换逻辑。
  - 确认导入/导出配置时可处理新结构。
- **权限与发布准备**
  - 设计 host 权限管理策略（静态白名单 + 文档，或动态申请流程）。
  - 更新用户文档说明新增供应商配置方式与权限影响。
  - 验证扩展在升级后能平滑迁移现有用户数据。

## 验收建议
- 在开发环境中逐步启用新配置，确保每一 Stage 完成后都能在扩展中手动完成一次“配置-测试-调用”闭环。
- 新增至少一位 OpenAI 兼容供应商（如 DeepSeek）作为验证样例，确认无需修改核心逻辑即可生效。

