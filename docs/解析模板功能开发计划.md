# 解析模板功能开发计划

> 依据 `docs/解析模板功能详细设计.md` 编制，目标是在保证 storage、popup、悬浮球、options 四端行为一致的前提下，交付一组可渐进落地的实现阶段。每个阶段完成后都要更新 `IMPLEMENTATION_PLAN.md` 中的状态，并进行自检，避免“修改单处忘同步”的问题。

## 项目总览
- **范围**：引入模板库（模板 CRUD + 默认/活动模板）、跨端模板选择同步、基于模板的解析与写入流程、Tailwind/i18n 对齐、遗留逻辑清理。
- **涉及核心模块**：
  - 数据层：`utils/storage.js`、新增 `utils/template-store.js`、`utils/prompt-engine.js`
  - 业务层：`popup/popup.js`、`content/content-main.js`、`content/floating-panel.js`
  - 设定 UI：`options/options.js`、`options/options.html`
  - 配套：`_locales/*/messages.json`、`styles/custom-classes.css`
- **关键依赖**：Chrome storage 监听、AnkiConnect 接口（deck/model/fields）、AI 解析服务（`utils/ai-service.js`）。
- **整体节奏**：建议 6 个阶段，前 2 个阶段完成“无 UI 的数据骨架”，再逐步刷新 options/popup/content，最后一次性补充 i18n/Tailwind/清理与测试。

---

## 阶段 1：模板数据结构与工具库
**目标**：在不破坏现有存储的前提下，完成 `templateLibrary` 结构、访问 API 与迁移动作，供 UI 接入。

- **范围**
  - 新建 `utils/template-store.js`（或同名模块），封装模板 CRUD、默认模板维护、活动模板写入/读取、排序与空态判断。
  - 升级 `utils/storage.js`，让 `buildDefaultConfig()`、`migrateConfig()`、`saveConfig()`、`loadConfig()` 支持 `templateLibrary` 与 `ui.activeTemplateId/templateSelectionSource`。
  - 调整 `utils/prompt-engine.js`，只保留通用 prompt 生成/校验逻辑，新增 `buildPromptFromTemplate()`、`normalizeTemplateFields()` 等模板专属函数，标记旧的 `loadPromptForModel` 系列为废弃。
- **主要任务**
  1. 定义模板/字段/选择状态的 TypeScript-like JSDoc（标准 IT 日语）并实现 `createTemplate`, `updateTemplate`, `deleteTemplate`, `setDefaultTemplate`, `setActiveTemplate`, `listTemplates` 等函数。
  2. 在 `storage.saveConfig()` 写入前调用模板归一化函数，保证字段顺序、时间戳等属性齐全；`loadConfig()` 中补齐缺省结构。
  3. `prompt-engine` 中实现模板驱动的 prompt 构造，并对 legacy “按模型存 prompt” 的入口打警告或提供只读兼容。
- **检查点**
  - `loadConfig()` 在完全没有 `templateLibrary` 数据时返回带空模板对象的 config。
  - 通过脚本模拟 `setActiveTemplate()` -> `chrome.storage.local` 数据里多出 `ui.activeTemplateId` 与 `templateSelectionSource`。
  - `buildPromptFromTemplate()` 能按模板字段顺序输出 schema。
- **交付**
  - `utils/template-store.js` + 对应单元测试脚本（若暂未配置测试框架，需附示例脚本或使用 `node` 临时校验）。
  - `utils/storage.js`、`utils/prompt-engine.js` 的更新及注释。
- **依赖/风险**
  - 需确认 `chrome.storage` 读写是否在内容脚本和 options 中均可复用，避免重复注入。

---

## 阶段 2：Options 模板管理界面与交互
**目标**：将 options 页重构为“模板列表 + 模板编辑器”，实现模板 CRUD、默认模板设置、Anki/Prompt 配置合并。

- **范围**
  - 重排 tab（`AI 配置`、`解析模板`、`界面样式`、`系统`），拆掉旧 `Anki`/`Prompt` tab。
  - 在 `options/options.html` 增加模板列表容器（空态 + 卡片 + CTA），模板表单视图（名称/描述/deck/model/字段/Prompt）。
  - `options/options.js` 接入模板 store：加载模板列表、驱动编辑态状态机、调用 AnkiConnect 获取 deck/model/字段、生成 prompt。
- **主要任务**
  1. 新建 `TemplateLibraryView`（JS 对象或 class）负责列表渲染、空态展示、设为默认、跳转编辑。
  2. 新建 `TemplateFormController`：封装表单校验、字段编辑、Prompt 生成/保存、取消恢复逻辑；写入 storage 前调用阶段 1 的模板 API。
  3. 复用现有 `promptEditorState`，但作用域改为“当前模板”；保证 `testConnection`、`getDeckNames`、`getModelFieldNames` 仍可被触发。
  4. 在 `options/options.js` 中监听 storage 变更，当其他端修改模板时刷新列表/表单。
  5. 更新 `_locales` 文案，确保 zh-CN/zh-TW/ja/en 四份 locale 同步。
- **检查点**
  - 无模板时显示空态 + “新增模板”按钮；新增后自动跳转编辑态并设为默认。
  - 模板列表的“设为默认”与“删除”操作即时反映在 `templateLibrary`.
  - 表单内 deck/model/字段联动正常，`生成 Prompt` 能读取模板字段并写回 prompt。
  - 旧的 `promptTemplates.promptTemplatesByModel` 在 UI 中不再被引用。
- **交付**
  - 更新后的 `options/options.html`、`options/options.js`、必要的 Tailwind class 与 tooltip 样式。
- **依赖/风险**
  - AnkiConnect 请求可能失败，需要在表单状态里展示错误并阻止保存。

---

## 阶段 3：Popup 模板选择与解析流程
**目标**：让 popup 端基于模板渲染字段、触发解析/写入、在无模板时给出空态提示。

- **范围**
  - `popup.html`、`popup/popup.js`：新增模板选择器、tooltip、禁用态提示、“重新解析”提示条。
  - 与 storage/template-store 打通：加载模板列表、设置活动模板、在 storage 变化时刷新 UI。
  - 更新解析/写入流程：AI 输入参数、字段渲染、按钮状态都来自模板。
- **主要任务**
  1. 构建 `renderTemplateSelector()`，按模板 `updatedAt` 排序，hover 提示 deck/model/字段。
  2. 在 `getActivePromptSetup()` 旁新增 `getActiveTemplate()`，若模板缺失则返回空态；所有下游逻辑使用模板字段而非 `ankiConfig.modelFields`。
  3. 修改 `handleParse()`：传入模板字段序列、模板 prompt；解析完成后把返回值映射到模板字段并渲染文本域。
  4. 修改 `handleWrite()`：deck/model/字段全部取自模板，缺字段直接阻止写入。
  5. 增加 storage 监听，若 `ui.activeTemplateId` 变化且来源不在 popup，自行刷新 UI。
  6. 当模板为空或字段为空时禁用解析/写入按钮，并展示 i18n 空态文案，引导用户打开 options。
- **检查点**
  - 切换模板时，字段区域实时刷新；若已有解析结果则提示“请重新解析”并禁用写入。
  - popup 自己切换模板不会反复响应 storage 事件（通过 `templateSelectionSource` 区分）。
  - 无模板时 `parse`/`write` 按钮禁用且 tooltip 给出跳转 options 的 CTA。
- **交付**
  - `popup/popup.js`+`popup.html` 更新、Tailwind 样式、tooltip 行为、状态提示文案。
- **依赖/风险**
  - popup 初始化顺序需确保在 `whenI18nReady()` 后再渲染模板列表，以免文案缺失。

---

## 阶段 4：内容脚本与悬浮球模板同步
**目标**：内容脚本负责消费 `templateLibrary`，悬浮球可切换模板并在模板变化后提示重新解析。

- **范围**
  - `content/content-main.js`：配置加载、storage 监听、`handleAIParsing`/`handleAnkiWrite` 全部转向模板数据。
  - `content/floating-panel.js`：新增模板选择器、tooltip、`showReparseHint()`/`setActiveTemplate()`。
- **主要任务**
  1. 在内容脚本初始化时读取 `templateLibrary`，若没有有效模板则隐藏悬浮球入口或展示空态提示。
  2. 实现 `setActiveTemplate(templateId, source)` 并写入 storage；storage 事件触发时刷新 panel + popup。
  3. 改写 `floatingPanel.renderFieldsFromConfig()` -> `renderFieldsFromTemplate(template)`，确保字段顺序与模板一致。
  4. 引入 `needsReparse` flag：当模板切换但当前选区仍在，显示“重新解析”按钮（复用 retry button），点击后调用 `handleAIParsing` 并清空 flag。
  5. Tooltip、禁用态、空态提示保持与 popup 文案一致（复用同一 i18n key）。
- **检查点**
  - 在悬浮球切换模板后，popup 打开时自动选中相同模板。
  - 模板切换后不触发立即写入，必须重新解析。
  - 内容脚本和 popup 对 storage 的监听不会互相造成无限循环。
- **交付**
  - 更新的 `content/content-main.js`、`content/floating-panel.js`、任何必要的样式/模板字符串。
- **依赖/风险**
  - 需确保悬浮球 iframe/shadow DOM 的样式不与 Tailwind 冲突；模板选择器要保持紧凑。

---

## 阶段 5：解析与写入管线全面切换
**目标**：让 AI 解析、字段校验、Anki 写入全部以模板为唯一数据源，移除对旧 `promptTemplatesByModel` 的依赖。

- **范围**
  - `utils/field-handler.js`、`utils/ai-service.js` 中若存在“按模型字段”逻辑，需要迁移为“按模板字段”。
  - `popup`、`content` 的解析/写入函数要与阶段 1 的工具保持一致，并在异常时提供上下文信息。
- **主要任务**
  1. 改造 `collectFieldsForWrite()/validateFields()`，输入参数改为模板字段定义 + 当前文本域值，校验顺序按 `order`。
  2. `parseTextWithDynamicFieldsFallback` 要支持接收模板字段 schema（字段名、说明、顺序），并把 AI 返回结果映射为 `{fieldName: value}`。
  3. `addNote()` 的参数准备逻辑统一走模板（deckName/modelName/modelId/fields）。
  4. 在解析/写入错误时，利用阶段 1 的工具附带模板名称/ID，方便日志追踪。
  5. 清理 `promptTemplates.custom` 供给链，只保留兼容读取。
- **检查点**
  - 使用同一模板在 popup 和悬浮球解析出的字段顺序完全一致。
  - 模板字段缺失或 AI 返回字段不匹配时，能够明确告知用户是哪个字段导致错误。
  - `templateLibrary.defaultTemplateId` 为空时，`activeTemplateId` 自动置空并触发空态。
- **交付**
  - 更新后的 AI/字段/Anki 交互函数，附带必要注释。
- **依赖/风险**
  - 需要确保所有调用方都使用新的模板接口，防止旧函数被遗忘；建议在代码里对旧接口加 `console.warn`。

---

## 阶段 6：i18n、Tailwind 对齐与回归测试
**目标**：补全所有文案/样式，执行设计文档第 11 节列出的测试用例，并清理遗留代码。

- **范围**
  - `_locales/en/messages.json`、`_locales/ja/messages.json`、`_locales/zh_CN/messages.json`、`_locales/zh_TW/messages.json` 中新增所有 key。
  - `styles/custom-classes.css` 仅保留 tooltip 等无法用 Tailwind 表达的样式，popup/options 其它结构全部使用 Tailwind。
  - 根据设计文档第 10 节删除废弃方法/CSS。
- **主要任务**
  1. 按设计文档第 8 节罗列的 key 更新四种语言文案，校对 placeholder/tooltip/按钮文本。
  2. 统一 popup/options 的 DOM class，必要时在 `custom-classes.css` 中用 `@apply` 定义 `.template-card` 等复用块。
  3. 执行第 11 节的测试清单（模板 CRUD、同步、禁用态、解析、重新解析、tooltip、多语言、Tailwind 兼容），记录结果。
  4. 移除 `options` 中的旧 tab DOM/监听器、`prompt-engine` 中旧的模型方法、`popup`/`content` 中依赖 `ankiConfig.modelFields` 的逻辑、冗余 CSS。
  5. 更新 `docs/解析模板功能详细设计.md` 中提到的“清理完成”状态（如需）。
- **检查点**
  - 切换语言后，options/popup/悬浮球的模板相关文本全部更新且无 missing key。
  - `styles/custom-classes.css` 无多余选择器，Tailwind 类统一。
  - 设计文档第 11 节的 8 组测试全部通过（可在计划或 PR 描述中列出结果）。
- **交付**
  - locale 文件、样式文件、清理提交，以及测试记录。
- **依赖/风险**
  - 注意 `_locales` 文件较多，需确保所有语言同步更新；Tailwind 类名变更后要回归查看暗色/浅色模式。

---

## 附加建议
- **同步机制**：popup 与内容脚本应共享一份 `templateSelectionSource` 逻辑，阶段 3/4 结束后务必交叉测试。
- **日志与回退**：为模板 CRUD、解析失败、Anki 写入失败分别打印结构化日志，方便后续排查。
- **实施顺序控制**：只有在阶段 1 完成并稳定后，才能进入阶段 2-5；否则 UI 侧无法获取稳定 API。
- **任务拆解**：每个阶段内部可再细分为 2-3 个 PR，但必须保证完成一个阶段前不要在多个端同时修改，避免互相阻塞。

本计划可直接交给负责实现的 AI 开发代理，作为开发清单与验收标准。途中若设计有更新，应先同步修改本计划与 `docs/解析模板功能详细设计.md`，再调整后续阶段的范围与检查点。
