# 解析模板功能详细设计

## 1. 背景与目标
- 参考 `docs/解析模板功能技术评估报告.md` 与当前代码（`popup/popup.js`, `content/floating-panel.js`, `options/options.js` 等）可知：现有实现仅支持按 Anki 模型维度保存 Prompt/字段，不具备用户可见的“解析模板”概念，也缺少跨界面同步能力。
- 本设计旨在：
  1. 提供统一的模板库，允许用户创建/编辑/删除解析模板并设置默认模板；
  2. 在 popup 与悬浮球面板中加入模板选择器，并保持两端状态同步；
  3. 让 options 页面承担“模板列表 + 模板编辑器”的角色，并复用现有的 Anki 连接与 Prompt 配置能力；
  4. 满足新的 UI/交互（Tailwind、tooltip、多语言、重新解析按钮等）和代码清理要求；
  5. 在“从 0 开始”的数据假设下，构建未来可扩展的存储结构。

## 2. 现状回顾与差距
| 模块 | 现状 | 差距 |
| --- | --- | --- |
| popup (`popup/popup.js/html`) | 依据 `config.promptTemplates.promptTemplatesByModel` 自动取默认模型，无模板下拉、无 tooltip，同步依赖 storage 默认模型 | 需要可选模板、禁用态提示、模板 hover 信息、Tailwind 布局调整 |
| 悬浮球 (`content/floating-panel.js`) | 仅支持 Legacy/动态字段模式，字段来自 config 中模型字段；没有模板切换入口、也没有重新解析按钮 | 需新增模板选择器、同步逻辑、模板变更后字段刷新与“重新解析”按钮 |
| options (`options/options.js/html`) | 通过“Anki 配置”+“Prompt 配置”两个 tab 调整 deck/model/字段与 Prompt；无模板概念，用户无法维护多个组合 | 需引入“解析模板”tab 作为列表页，并将 Anki & Prompt 的内容合并为模板新增/编辑页；列表需支持默认/删除 |
| 存储 (`utils/storage.js`) | 核心结构为 `ankiConfig`+`promptTemplates`；prompt 与字段挂在模型上 | 需引入 `templateLibrary`（含模板数组、默认模板、版本号等），淘汰旧结构 |
| Prompt 引擎 (`utils/prompt-engine.js`) | 聚焦字段 -> Prompt 的生成与校验 | 需提供基于模板的数据结构读写、字段配置序列化等能力 |

## 3. 设计原则与约束
1. **多语言**：所有新增 UI 文案必须通过 `_locales/*/messages.json` 管理；tooltip 内容也需拼接 i18n 文案。
2. **Tailwind**：popup 与 options 的新增/改动样式全部使用 `styles/tailwind.min.css` 提供的类，必要时在 `styles/custom-classes.css` 中用 `@apply` 补充；悬浮球面板可继续使用其私有样式块。
3. **零数据迁移**：视为首次启用模板功能；旧的 `promptTemplates`/`defaultModel` 数据不再消费，缺省即为“未配置模板”。
4. **同步优先**：模板选择需通过 `chrome.storage.local` 保存（`ui.activeTemplateId`），依靠内容脚本/popup 自带的 storage 监听来同步状态。
5. **清晰可测**：模板 CRUD、解析流程、重新解析按钮等需可通过现有手动测试验证；必要的工具函数需配备标准 IT 日语注释。
6. **清理遗留**：功能上线后移除已无调用关系的方法/样式（见第 10 节），避免双轨制。

## 4. 数据模型与状态同步
### 4.1 配置结构新增
在 `ankiWordAssistantConfig` 根节点新增 `templateLibrary` 与 `ui.templateSelection`：
```json
{
  "templateLibrary": {
    "version": 1,
    "defaultTemplateId": null,
    "templates": {
      "tpl_001": {
        "id": "tpl_001",
        "name": "基础释义",
        "description": "双字段释义模板",
        "deckName": "Default",
        "modelName": "Basic",
        "modelId": 123456789,
        "fields": [
          {
            "name": "Front",
            "label": "正面",
            "parseInstruction": "输出单词+词性",
            "order": 0
          },
          {
            "name": "Back",
            "label": "背面",
            "parseInstruction": "输出中文释义",
            "order": 1
          }
        ],
        "prompt": "...完整 prompt...",
        "createdAt": "2025-11-12T10:00:00Z",
        "updatedAt": "2025-11-12T10:05:00Z"
      }
    }
  },
  "ui": {
    "activeTemplateId": "tpl_001",
    "templateSelectionSource": "popup"
  }
}
```
- `templateLibrary.templates` 采用对象存储（id->模板），便于快速读取与更新。
- `modelId` 可选，用于未来校验；如 `ankiconnect` 返回。
- `order` 确保字段顺序在 UI 中稳定。
- `templateSelectionSource`（可选）帮助 popup/内容脚本判断是否需要忽略自己发起的 storage 变更，避免重复渲染。

### 4.2 模板字段结构
每个字段项包含：
- `name`: 与 Anki 模型字段名对齐；
- `label`: 可展示的人类可读名称（默认 = name，允许手动覆盖）；
- `parseInstruction`: 替代旧 `fieldConfigs[field].content`；
- `order`: int，配合 `Array.sort` 保障顺序；
- `isRequired`: bool，控制 UI 校验与解析时必填提示；
- `aiStrategy`: `"auto"|"manual"`，其中 `auto` 走 AI 解析，`manual` 表示该字段由用户手填（满足未来扩展）。

### 4.3 UI 选择状态
- `templateLibrary.defaultTemplateId`: options 页面“设为默认”操作写入；popup/悬浮球在 `activeTemplateId` 缺省时回退到默认值。
- `ui.activeTemplateId`: popup 与悬浮球当前选中项。两端切换时需调用新的 `saveActiveTemplateId(templateId, source)` API，以触发 storage 事件。
- 当模板被删除：
  - 若删除的是 `activeTemplateId`，自动回退到 `defaultTemplateId`；
  - 若两者都不存在，写入 `null` 并在 UI 中展示“尚未配置模板”的禁用态。

### 4.4 与旧结构的关系
- `promptTemplates`、`ankiConfig.defaultModel`、`ankiConfig.modelFields` 将不再驱动 UI；保留字段仅为兼容旧版本（防止读取失败）。
- `storage.loadConfig` 在返回对象时需注入空的 `templateLibrary` & `ui.activeTemplateId` 默认值，确保旧配置不会破坏流程。

## 5. 模块改造清单
### 5.1 新增 `utils/template-store.js`
主要职责：
- `loadTemplateLibrary(config)`：从整体 config 提取模板库，若缺省返回空结构；
- `getTemplateById(config, templateId)`：读取模板；
- `saveTemplate(config, template)`：写入/更新单个模板；
- `deleteTemplate(config, templateId)`：移除模板，同时清空 default/active；
- `setDefaultTemplate(config, templateId)`；
- `setActiveTemplate(config, templateId, source)`；
- `listTemplates(config)`：返回数组并按 `updatedAt` 排序。
> 所有导出方法添加标准 IT 日语的 JSDoc 与必要的行内注释。

### 5.2 `utils/storage.js`
- 在 `buildDefaultConfig` 中增加 `templateLibrary` 与 `ui.activeTemplateId` 默认值；
- `migrateConfig` 调整：若 `templateLibrary` 缺省则补空；
- 新增 `patchConfig(updater)`（若需要）以避免整份 config 的深拷贝；
- 清理 `promptTemplates.custom/promptTemplatesByModel` 的写入逻辑，保留只读兼容；
- 保存时仅序列化新的模板结构。

### 5.3 `utils/prompt-engine.js`
- 保留 `buildIntegratedPrompt` 等函数；
- 新增 `buildPromptFromTemplate(template, userInput)`：直接消费模板里的字段/指令；
- 新增 `normalizeTemplateFields(fields)` 帮助 options 页面校验输入；
- 移除/标记废弃 `loadPromptForModel`, `savePromptForModel`, `updatePromptConfigForModel`, `getPromptConfigForModel`。

### 5.4 popup (`popup/popup.js` + html)
- 引入模板选择器组件：
  - 使用 Tailwind：`flex items-center justify-between gap-2 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2`；
  - `<select id="template-select">` + tooltip 按钮（`title` + 自定义 `<div>`）显示“牌组 / 模板 / 字段列表”。
- `loadTemplateOptions()`：将 `templateLibrary.templates` 转成下拉项，按更新时间排序；
- `applyTemplate(templateId)`：
  1. 更新 `ui.activeTemplateId`（调用 `template-store` API 保存到 storage）；
  2. 重新渲染字段输入区域，顺序来自模板 `fields.order`；
  3. 更新 prompt/字段文案，对 parse 按钮/写入按钮做启用/禁用；
  4. 若当前文本已存在，提示用户重新解析。
- 当模板为空时：
  - parse 与 write 按钮 `disabled`；
  - 在头部 `status-message` 显示 i18n 文案“请前往设置页创建模板”；
  - 解析按钮点击时直接弹出 `options` 页链接（`chrome.runtime.openOptionsPage()`）。

### 5.5 内容脚本 (`content/content-main.js`)
- `getActivePromptSetup` 重写：读取模板而非模型字段；
- 在 `controller.applyConfigUpdate` 中加入逻辑：
  - 若模板变更且面板已展开，调用 `floatingPanel.renderTemplate(template)`；
  - 若 `activeTemplateId` 变化且存在 `currentSelection`，展示 `重新解析` 按钮。
- `handleAIParsing`：传入模板字段集合给 `parseTextWithDynamicFieldsFallback`；其 prompt 来自模板。
- `handleAnkiWrite`：deck/model 取自模板，字段集合来自模板 `fields`；若模板缺字段直接报错。

### 5.6 悬浮球面板 (`content/floating-panel.js`)
- Header 内新增模板选择器（保持定制样式）：
  - `<select class="template-select">` + info icon；
  - 选中项与 tooltip 内容同 popup；
  - 选择变化时调用内容脚本的 `setActiveTemplate`。
- 新增 `showReparseHint()`：
  - 复用现有 `retryButton`，但当 `reason === "template-change"` 时渲染文本 `重新解析`，并保持按钮常显直到执行成功；
  - 在 `floatingPanel.showReady` 内根据 `panelState.needsReparse` 控制重解析按钮显示。
- `renderFieldsFromConfig` 改为 `renderFieldsFromTemplate(template)`，根据模板 `fields` 生成 textarea；
- 当模板为空或字段为空时，用空提示替代输入区域。

### 5.7 options 页面 (`options/options.js`/`options/options.html`)
1. **Tab 重构**：
   - Tab 顺序：`AI 配置`、`解析模板`、`界面样式`、`系统`；原 `Anki` & `Prompt` tab 被移除。
2. **模板列表视图**：
   - 位置：`#template-library-panel`（新增）；
   - 内容：空态提示 + “新增模板”按钮 + 模板卡片列表。
   - 模板卡片包含：名称、描述、牌组/模板摘要、字段数、最后更新时间、`设为默认`（radio）/`编辑`/`删除`按钮；使用 Tailwind `grid gap-4` 布局。
3. **模板编辑视图**：
   - 复用既有 `promptEditorState`，但作用域改为“当前编辑的模板”；
   - 表单区块：
     1. 基本信息（名称、描述）；
     2. Anki 连接（`测试连接`按钮 + 牌组/模板选择下拉 + 字段映射展示）；
     3. 字段选择 + 字段解析内容（沿用现有 UI，只是布局整合在此视图中）；
     4. Prompt 编辑/生成器（沿用 `generate prompt` 按钮）；
     5. 底部操作（保存、取消）。
   - 通过 `data-view="template-form"` 与 `data-view="template-list"` 切换可见性；取消按钮返回列表。
4. **状态 & 校验**：
   - 必填：名称、描述、deck、model、至少一个字段、Prompt；
   - 字段解析内容为空时阻止保存并高亮；
   - `保存` 时写入 `template-store`，若 `templates` 为空则自动将首个模板设为默认。
5. **Tailwind**：列表与表单均使用 `card` 风格 `border rounded-lg shadow-sm bg-white`；尽量不用额外 CSS，如需 tooltip 过渡可在 `custom-classes.css` 里用 `@apply`。
6. **交互**：
   - 删除前二次确认（`confirm` + i18n 文案）；
   - `设为默认` 仅允许存在一个 true，点击时立即写入 storage 并提示成功。

### 5.8 其他
- `_locales/*/messages.json`：添加新键（详见第 8 节）。
- `styles/custom-classes.css`：仅保留 tooltip 动画（如 popup/floating 面板需要的 `hover-card`），其余由 Tailwind 负责。

## 6. UI 与交互设计
### 6.1 Popup
```
+-----------------------------------------------------+
| 模板选择器  [▼]  (i)  |  状态提示文本              |
+-----------------------------------------------------+
| 文本输入 textarea (自动高度)                        |
+-----------------------------------------------------+
| 字段区域 (按模板字段渲染卡片)                      |
+-----------------------------------------------------+
| [解析按钮]                                          |
| [写入 Anki]                                         |
+-----------------------------------------------------+
```
- 模板选择器 hover 时展示 tooltip：
  - 第一行：`牌组：{deck} / 模板：{model}`；
  - 第二行：`字段：Front, Back, ...`。
- 当模板切换：
  - 立即禁用解析按钮，显示“请重新解析”黄色提示；
  - 等用户点击解析后再恢复写入按钮。

### 6.2 悬浮球面板
- 模板选择器位于标题右侧，采用紧凑样式避免占位过多；
- 当模板变化：
  1. 字段区域重新渲染；
  2. 面板头部出现 info 提示；
  3. `重新解析`（改造后的 retry button）出现，点击后复用 `handleAIParsing`；
  4. 若当前无选区，则提示用户重新选择文本。

### 6.3 options 页面
- **列表态**：使用 `grid grid-cols-1 md:grid-cols-2 gap-4` 布局。每张卡：
  - 左侧：标题+描述+字段/牌组摘要；
  - 右侧：操作按钮（默认/编辑/删除）。
- **表单态**：采用 `space-y-6` 纵向分组；字段解析区仍用 `cards` 显示单个字段的 textarea。
- **空态**：展示插画或图标 + 文案 + CTA。

### 6.4 Tooltip 设计
- popup：使用 `relative group` + `absolute` tooltip，实现 Tailwind `group-hover:block`；
- 悬浮球：已有自定义 CSS，可在 `.template-tooltip` 中定义背景/阴影。

## 7. 关键流程
1. **启动 & 默认模板加载**：
   - popup 打开或悬浮球初始化 -> 读取 config -> 若 `activeTemplateId` 存在则加载对应模板，否则尝试 default -> 无模板则呈现禁用空态。
2. **模板切换**：
   - 用户在 popup/悬浮球选择模板 -> 调用 `setActiveTemplate(templateId, source)` 存储 -> 另一端通过 `chrome.storage.onChanged` 监听到变更，刷新 UI。
3. **解析**：
   - `parseTextWithDynamicFieldsFallback` 入参包含模板字段顺序和 prompt；
   - AI 结果校验字段名与模板字段匹配，不匹配则报错。
4. **写入**：
   - `addNote` 入参 deck/model 取模板值，字段值按模板 order 填入，缺失字段填空。
5. **重新解析按钮**：
   - 当 `activeTemplateId` 改变且 `currentSelection` 存在 -> `floatingPanel` 标记 `needsReparse=true` 并展示按钮；
   - 按钮调用 `handleAIParsing`，成功后清除 flag。
6. **模板 CRUD**：
   - 新增/编辑 -> 表单 -> 校验 -> 写入 `templateLibrary` -> 若没有默认模板则将当前模板设为默认 -> 通知用户；
   - 删除 -> 若删除默认或当前模板，则清空 `defaultTemplateId`/`activeTemplateId` 并触发空态。

## 8. 文案与 i18n
需新增/更新的 key（示例）：
- `template_library_tab_label`
- `template_library_empty_title`
- `template_library_empty_description`
- `template_library_add_button`
- `template_card_fields_label`
- `template_card_set_default`
- `template_card_default_badge`
- `template_card_delete_confirm`
- `template_form_title_new`
- `template_form_title_edit`
- `template_form_name_label`
- `template_form_description_label`
- `template_form_deck_label`
- `template_form_model_label`
- `template_form_fields_section`
- `template_form_prompt_section`
- `template_form_generate_prompt`
- `template_form_save`
- `template_form_cancel`
- `template_form_validation_name`
- `template_form_validation_fields`
- `popup_template_selector_label`
- `popup_template_empty_state`
- `popup_template_hover_deck_model`
- `popup_template_hover_fields`
- `popup_template_change_notice`
- `floating_template_change_notice`
- `floating_template_retry_button`
- `options_toast_template_saved`
- `options_toast_template_deleted`
> 每个 key 在 zh-CN/zh-TW/ja/en 四份 locale 中都要补齐。

## 9. Tailwind 与样式策略
- popup 与 options 的新增 DOM 结构全部使用 Tailwind utility class，必要时通过 `@apply` 提炼（如 `.template-card`）。
- 弹性布局示例：`class="flex items-center gap-2"`、`class="grid grid-cols-1 md:grid-cols-2 gap-4"`。
- Tooltip 若需动画，可在 `custom-classes.css` 定义 `.tooltip` 并用 `@apply bg-slate-900 text-white text-xs px-2 py-1 rounded shadow-lg`。
- 悬浮球面板仍沿用其内联 `<style>`，但新增选择器需保证命名空间（如 `.panel .template-select`）。

## 10. 清理与重构要求
- 移除/废弃：
  - `utils/prompt-engine.js` 中的 `loadPromptForModel/savePromptForModel/updatePromptConfigForModel/getPromptConfigForModel`；
  - `config.promptTemplates` 的写入逻辑；
  - `options/options.js` 中与旧 tab 直接相关的 DOM 选择/事件监听；
  - `popup/popup.js` & `content/content-main.js` 内对 `ankiConfig.modelFields` 的依赖；
  - 未再使用的 CSS（例如 options 中 tab 动画）。
- 新增方法需附日语注释，复杂逻辑可加少量中文行注释。

## 11. 测试计划
1. **模板 CRUD**：
   - 新增模板（含生成 prompt、字段校验）
   - 编辑模板并验证更新时间变更
   - 删除模板并观察默认/活动模板回退
2. **同步**：
   - 在 popup 切换模板 -> 悬浮球立即反映
   - 在悬浮球切换模板 -> 打开 popup 时默认选中相同模板
3. **禁用态**：
   - 无模板时 popup/悬浮球按钮禁用，提示文案正确
4. **解析流程**：
   - 有模板时成功解析并写入；
   - 模板字段/AI 返回字段不匹配时展示错误
5. **重新解析按钮**：
   - 模板切换后出现按钮；
   - 点击后使用旧选区重新生成并消失
6. **Tooltip**：
   - hover 时信息与模板一致且支持语言切换
7. **多语言**：
   - 切换语言后模板列表、表单、popup/悬浮球文案同步变化
8. **Tailwind 兼容**：
   - 检查 popup/options 页面在浅色/深色模式下视觉一致

## 12. 风险与后续
- **Anki 数据失效**：用户在模板外部重命名 deck/model 会导致模板失效。解决：保存 `modelId` 并在解析前尝试校验，失败时给出“请更新模板”的提示。
- **storage 频繁写入**：模板切换频繁会多次调用 `saveConfig`。可在 `setActiveTemplate` 内检测变化后再写入，避免重复。
- **旧数据抛弃**：由于不迁移旧 Prompt 配置，老用户需重新创建模板。需在 release note 与空态文案中说明。
- **后续扩展**：`templateLibrary.version` 预留未来结构升级；`aiStrategy` 为混合解析留钩子。

---
本设计文档位于 `docs/解析模板功能详细设计.md`，后续开发需：
1. 严格对照本文更新代码；
2. 在 `IMPLEMENTATION_PLAN.md` 中同步阶段状态；
3. 新增/修改方法均补充日语注释；
4. 完成开发后清理已标记的旧逻辑。
